name: Release on Version Bump

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect version bump
        id: version
        run: |
          set -euo pipefail

          NEW_VERSION=$(jq -r .version precise/package.json)

          if git show HEAD^:precise/package.json >/tmp/previous-package.json 2>/dev/null; then
            PREVIOUS_VERSION=$(jq -r .version /tmp/previous-package.json)
          else
            PREVIOUS_VERSION=""
          fi

          {
            echo "new_version=$NEW_VERSION"
            echo "previous_version=$PREVIOUS_VERSION"
          } >> "$GITHUB_OUTPUT"

          if [ "$NEW_VERSION" = "$PREVIOUS_VERSION" ]; then
            echo "bumped=false" >> "$GITHUB_OUTPUT"
            echo "No version bump detected; skipping release creation."
            exit 0
          fi

          echo "bumped=true" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        if: steps.version.outputs.bumped == 'true'
        run: |
          set -euo pipefail

          PREVIOUS_TAG=$(git tag --list "*.*.*" --sort=-v:refname | head -n 1 || true)

          if [ -n "$PREVIOUS_TAG" ]; then
            RANGE="${PREVIOUS_TAG}..HEAD"
            LOG=$(git log --no-merges --pretty=format:"- %s (%h)" "$RANGE")
          else
            LOG=$(git log --no-merges --pretty=format:"- %s (%h)")
          fi

          if [ -z "$LOG" ]; then
            LOG="Changelog not available."
          fi

          {
            echo "changelog<<'EOF'"
            echo "$LOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        if: steps.version.outputs.bumped == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: ${{ steps.version.outputs.new_version }}
          body: ${{ steps.changelog.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
